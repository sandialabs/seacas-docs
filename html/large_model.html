<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Exodus: Large model modifications to the Exodus library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Exodus
   &#160;<span id="projectnumber">7.22</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('large_model.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Large model modifications to the Exodus library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="large_model_"></a>
Large model modifications to the Exodus library</h1>
<dl class="section note"><dt>Note</dt><dd>The changes documented below are now the default method for storing an Exodus database. There is no reason to write a "non-large" model database.</dd></dl>
<p>The changes are to support the storage of larger models. There are two pieces of this. The first is the setting of the type of netCDF file that will be created; either one with 32-bit offsets or one with 64-bit offsets. (Note that this is <em>not</em> related to storing 64-bit integers). This can be specified in a couple ways:</p>
<ol type="1">
<li>Pass the <code>EX_LARGE_MODEL</code> flag in the mode argument to ex_create.</li>
<li>Set the environment variable <code>EXODUS_LARGE_MODEL</code>.</li>
</ol>
<p>If either of these are set, then the library will pass the <code>NC_64BIT_OFFSET</code> flag to the netCDF library. See the commit log for netCDF library for more details.</p>
<p>The other change is to reduce the size of some of the datasets in an Exodus library. Even with the netCDF changes, the maximum dataset size is still 2 GiB. To reduce the size of the datasets, the nodal coordinates and the nodal variables have been split to store by component. The old behavior stored all x, y, and z coordinates in a single dataset; in the new behavior, each component is stored separately &ndash; there is a coordx, coordy, and coordz dataset.</p>
<p>The nodal variables used to be stored in a single blob of dimension <code>(#times,#nodes,#variables)</code>. This has now been split into <code>#variable</code> datasets of size <code>(#times,#nodes)</code>.</p>
<p>These two changes should increase the maximum model sizes significantly. Prior to the change, the maximum number of nodes that could be stored in the coordinate dataset was about 90 Million nodes; the new storage permits 270 Million nodes in double precision. The old model was more restrictive if there were multiple nodal variables, but the new storage should not depend on the number of nodal variables.</p>
<p>These changes were made such that the new library would create old-style files by default and would read either old or new style files. The version has been changed to 3.01 for the file version and 4.01 for the API version.</p>
<p>An additional attribute is now written to the file. It is called "file_size" or <code>ATT_FILESIZE</code>. If it is 0 or not present, then the old format is assumed; if it is 1, then the new format is assumed.</p>
<p>There is also a new internal function called <code><a class="el" href="group__Utilities.html#gaa8231cf6c15bb76730fd5903a3ad5777">ex_large_model(int exoid)</a></code> which will return 1 if new version; 0 if old version.</p>
<p>If the function is passed a negative exoid, then it will check the environment variable <code>EXODUS_LARGE_MODEL</code> and return 1 if it is defined. It also currently prints a warning message saying that the large model size was selected via the environment variable.</p>
<p>If you are using the Exodus api, then the only change to the client application is the passing of the <code>EX_LARGE_MODEL</code> flag to <code>ex_create</code> or the setting of the <code>EXODUS_LARGE_MODEL</code> environment variable. If your client application is reading the database, no changes are needed.</p>
<hr  />
<p> If your client application bypasses some or all of the Exodus API and makes direct netCDF calls, you will need to modify the calls. The changes that were made are shown below along with the name of the Exodus API function in which the changes were made.</p>
<p>Alternatively, you can look at the changes that were made to the API at <a href="http://github.com/gsjaardema/seacas/packages/seacas/libraries/exodus/src">http://github.com/gsjaardema/seacas/packages/seacas/libraries/exodus/src</a>. The files that were changed are:</p>
<dl class="section note"><dt>Note</dt><dd>The filenames have been changed since this was written.<ul>
<li>exgnvt.c</li>
<li>expcor.c</li>
<li>expini.c</li>
<li>expnv.c</li>
<li>expvp.c</li>
<li>expvpc.c</li>
<li><a class="el" href="ex__utils_8c.html">ex_utils.c</a></li>
<li>excopy.c</li>
<li>excre.c</li>
<li>exgcor.c</li>
<li>exgnv.c</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="ex_create"></a>
ex_create():</h1>
<p>&ndash; Check whether the <code>EX_LARGE_MODEL</code> mode was set. If so, then the mode passed to nccreate must have the <code>NC_64BIT_OFFSET</code> bit set. For example, <code>mode |= NC_64BIT_OFFSET;</code></p>
<p>NOTE: <code>NC_64BIT_OFFSET</code> is defined in the Sandia's netCDF version "3.4-snl10X". It should also be in netCDF-3.6.0 once it is released.</p>
<p>&ndash; Write the exodus file size <code>ATT_FILESIZE</code> attribute (1=large, 0=normal):</p>
<div class="fragment"><div class="line">filesiz = (nclong)(((cmode &amp; EX_LARGE_MODEL) != 0) || (ex_large_model(-1) == 1));</div>
<div class="line">   if (ncattput (exoid, NC_GLOBAL, ATT_FILESIZE, NC_LONG, 1, &amp;filesiz) == -1)</div>
<div class="line">    ... handle errors...</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_put_init"></a>
ex_put_init():</h1>
<p>&ndash; If writing a "large model" capable database, then the coordinates are defined as components instead of an array. The variables are <code>VAR_COORD_X</code>, <code>VAR_COORD_Y</code> (if 2D or 3D), <code>VAR_COORD_Z</code> (if 3D). If not, define the <code>VAR_COORD</code> variable as is currently done.</p>
<div class="fragment"><div class="line">   if (ex_large_model(exoid) == 1) {</div>
<div class="line">     /* node coordinate arrays -- separate storage... */</div>
<div class="line">     dim[0] = numnoddim;</div>
<div class="line">     if (ncvardef (exoid, VAR_COORD_X, nc_flt_code(exoid), 1, dim) == -1)</div>
<div class="line">{ ... handle error }</div>
<div class="line">     </div>
<div class="line">     if (num_dim &gt; 1) {</div>
<div class="line">if (ncvardef (exoid, VAR_COORD_Y, nc_flt_code(exoid), 1, dim) == -1)</div>
<div class="line">  { ... handle error }</div>
<div class="line">     }</div>
<div class="line">     </div>
<div class="line">     if (num_dim &gt; 2) {</div>
<div class="line">if (ncvardef (exoid, VAR_COORD_Z, nc_flt_code(exoid), 1, dim) == -1)</div>
<div class="line">  { ... handle error }</div>
<div class="line">     }</div>
<div class="line">   } else {</div>
<div class="line">     /* node coordinate arrays: -- all stored together (old method) */</div>
<div class="line">     .... define the old way...</div>
<div class="line">   }       </div>
</div><!-- fragment --><h1><a class="anchor" id="ex_put_coord"></a>
ex_put_coord():</h1>
<p>&ndash; If writing a "large model" capable database, then the coordinates are written a component at a time, otherwise write the old way as a single blob.</p>
<div class="fragment"><div class="line"> if (ex_large_model(exoid) == 0) {</div>
<div class="line">   ... write coordinates old way...</div>
<div class="line"> } else {</div>
<div class="line">   if ((coordidx = ncvarid (exoid, VAR_COORD_X)) == -1)</div>
<div class="line">     { ... handle error }</div>
<div class="line">   </div>
<div class="line">   if (num_dim &gt; 1) {</div>
<div class="line">     if ((coordidy = ncvarid (exoid, VAR_COORD_Y)) == -1)</div>
<div class="line">{ ... handle error }</div>
<div class="line">   } else {</div>
<div class="line">     coordidy = 0;</div>
<div class="line">   }</div>
<div class="line">   if (num_dim &gt; 2) {</div>
<div class="line">     if ((coordidz = ncvarid (exoid, VAR_COORD_Z)) == -1)</div>
<div class="line">{ ... handle error }</div>
<div class="line">   } else {</div>
<div class="line">     coordidz = 0;</div>
<div class="line">   }</div>
<div class="line">   /* write out the coordinates  */</div>
<div class="line">   for (i=0; i&lt;= num_vars; i++) {</div>
<div class="line">     dims[0] = time_dim;</div>
<div class="line">     dims[1] = num_nod_dim;</div>
<div class="line">     if ((ncvardef (exoid, VAR_NOD_VAR_NEW(i),</div>
<div class="line">      nc_flt_code(exoid), 2, dims)) == -1)</div>
<div class="line">{  ... handle error ... }</div>
<div class="line">   }</div>
<div class="line"> }</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_put_nodal_var"></a>
ex_put_nodal_var():</h1>
<p>&ndash; If the large model method, write the nodal variable data to the correct variable; if the old method, determine the location within the blob</p>
<div class="fragment"><div class="line">  if (ex_large_model(exoid) == 0) {</div>
<div class="line">    /* write values of the nodal variable */</div>
<div class="line">    if ((varid = ncvarid (exoid, VAR_NOD_VAR)) == -1) {</div>
<div class="line">      ... handle error...</div>
<div class="line">    }</div>
<div class="line">    start[0] = --time_step;</div>
<div class="line">    start[1] = --nodal_var_index;</div>
<div class="line">    start[2] = 0;</div>
<div class="line">    </div>
<div class="line">    count[0] = 1;</div>
<div class="line">    count[1] = 1;</div>
<div class="line">    count[2] = num_nodes;</div>
<div class="line">  } else {</div>
<div class="line">    /* nodal variables stored separately, find variable for this variable</div>
<div class="line">index */</div>
<div class="line">    if ((varid = ncvarid (exoid, VAR_NOD_VAR_NEW(nodal_var_index))) == -1) {</div>
<div class="line">      ... handle error ...</div>
<div class="line">    }</div>
<div class="line">      </div>
<div class="line">    start[0] = --time_step;</div>
<div class="line">    start[1] = 0;</div>
<div class="line"> </div>
<div class="line">    count[0] = 1;</div>
<div class="line">    count[1] = num_nodes;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  if (ncvarput (exoid, varid, start, count,</div>
<div class="line">  ex_conv_array(exoid,WRITE_CONVERT,nodal_var_vals,num_nodes)) == -1) {</div>
<div class="line">    ...handle error ...</div>
<div class="line">  }</div>
</div><!-- fragment --><p>There are similar modifications to the reading of the nodal coordinates and the reading of nodal variables. If interested in those functions, see the viewcvs URL listed above.</p>
<p>If there are any questions, contact: Greg Sjaardema <a href="#" onclick="location.href='mai'+'lto:'+'gds'+'ja'+'ar@'+'sa'+'ndi'+'a.'+'gov'; return false;">gdsja<span style="display: none;">.nosp@m.</span>ar@s<span style="display: none;">.nosp@m.</span>andia<span style="display: none;">.nosp@m.</span>.gov</a> 505-844-2701 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
